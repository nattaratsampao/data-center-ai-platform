// lib/line-bot.ts
import { getServerStates, getSensorStates } from "@/lib/event-simulator"

// --- Interfaces ---
export interface LineBotConfig {
  channelAccessToken: string
  channelSecret: string
  enabled: boolean
}

export interface LineBotAlert {
  type: string
  severity: string
  title: string
  description: string
  aiConfidence?: number // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Optional
  aiResponse?: string   // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° field ‡∏ô‡∏µ‡πâ
  timestamp?: string | Date
}

// --- Functions ---

// 1. ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ LINE ‡∏Ñ‡∏ô‡πÉ‡∏î‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á (Push)
export async function sendLineBotAlert(userId: string, alert: LineBotAlert): Promise<boolean> {
  try {
    const message = formatAlertForLineBot(alert)

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API Route ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
    const response = await fetch("/api/line/push", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        userId,
        message,
      }),
    })

    return response.ok
  } catch (error) {
    console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≤‡∏á LINE Bot:", error)
    return false
  }
}

// 2. ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Broadcast)
export async function broadcastLineBotAlert(alert: LineBotAlert): Promise<boolean> {
  try {
    const message = formatAlertForLineBot(alert)

    const response = await fetch("/api/line/broadcast", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        message,
      }),
    })

    return response.ok
  } catch (error) {
    console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö broadcast:", error)
    return false
  }
}

// 3. ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Alert
export function formatAlertForLineBot(alert: LineBotAlert): string {
  const severityEmoji: Record<string, string> = {
    critical: "üö®",
    high: "‚ö†Ô∏è",
    medium: "‚ö°",
    low: "‚ÑπÔ∏è",
  }

  const typeText: Record<string, string> = {
    anomaly: "‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥",
    prediction: "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏à‡∏≤‡∏Å AI",
    optimization: "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á",
    cpu_spike: "CPU ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏π‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥",
    memory_leak: "‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö Memory Leak",
    cooling_failure: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏¢‡πá‡∏ô‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á",
    temperature_spike: "‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î",
  }

  const emoji = severityEmoji[alert.severity] || "üì¢"
  const title = typeText[alert.type] || alert.type
  const time = alert.timestamp 
    ? new Date(alert.timestamp).toLocaleString("th-TH") 
    : new Date().toLocaleString("th-TH")

  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á AI Response (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  const aiSection = alert.aiResponse 
    ? `\nü§ñ AI Action: ${alert.aiResponse}` 
    : (alert.aiConfidence ? `\nü§ñ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à AI: ${alert.aiConfidence}%` : "")

  return `${emoji} ${title}

üìå ${alert.title}

${alert.description}
${aiSection}

‚è∞ ${time}

(‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö)`
}

// 4. ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö (‚úÖ ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏™‡∏î‡∏à‡∏≤‡∏Å Memory ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á fetch)
export async function formatSystemStatusForLine(): Promise<string> {
  try {
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡πÜ ‡∏à‡∏≤‡∏Å Simulator (‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏Å‡∏ß‡πà‡∏≤ fetch)
    const servers = getServerStates()
    const sensors = getSensorStates()

    const totalServers = servers.length
    const onlineServers = servers.filter(s => s.status === 'online' || s.status === 'warning').length
    
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Temp (‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏≤‡∏Å sensor ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô temp)
    const tempSensors = sensors.filter(s => s.type === 'temperature')
    const avgTemp = tempSensors.length > 0
      ? (tempSensors.reduce((sum, s) => sum + s.value, 0) / tempSensors.length).toFixed(1)
      : "N/A"
    
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Power
    const powerSensor = sensors.find(s => s.type === 'power')
    const powerVal = powerSensor ? powerSensor.value.toFixed(1) : "N/A"

    // Mock Uptime (‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏£‡∏¥‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ)
    const uptime = "99.98"

    return `üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Data Center

üñ•Ô∏è ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${onlineServers}/${totalServers} ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${avgTemp}¬∞C
‚ö° ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô: ${powerVal} kW
üîÑ Uptime: ${uptime}%

${onlineServers === totalServers ? "‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥" : "‚ö†Ô∏è ‡∏°‡∏µ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡πà‡∏ß‡∏ô!"}

‡∏û‡∏¥‡∏°‡∏û‡πå "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π alerts ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`
  } catch (error) {
    console.error("Error fetching system status:", error)
    return "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ"
  }
}